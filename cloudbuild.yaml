steps:
# Step 1: Set up SSH directory and key
- name: 'gcr.io/cloud-builders/gcloud'
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    mkdir -p /root/.ssh
    gcloud secrets versions access latest --secret=cloud-build-ssh-key > /root/.ssh/id_rsa
    chmod 600 /root/.ssh/id_rsa
    ssh-keyscan -H instance-20240817-002533 >> /root/.ssh/known_hosts

# Step 2: Deploy to Compute Engine VM
- name: 'gcr.io/cloud-builders/gcloud'
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    ssh -i /root/.ssh/id_rsa -o StrictHostKeyChecking=no instance-20240817-002533 \
    'cd ~/styl && git pull && docker compose down && docker system prune -f && docker volume rm $(docker volume ls -qf dangling=true | xargs) && docker compose up -d --build'

options:
  logging: CLOUD_LOGGING_ONLY